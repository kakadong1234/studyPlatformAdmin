<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>智慧党建 |  文章新建</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="../css/animate.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <script src="../js/angularjs/angular.min.js"></script>

</head>

<body ng-app="myApp" ng-controller="myCtrl"  data-ng-init="load()">

<div id="wrapper">

    <nav class="navbar-default navbar-static-side" role="navigation">
        <div class="sidebar-collapse">
            <ul class="nav metismenu" id="side-menu">
                <li class="nav-header">
                    <div class="dropdown profile-element">
                        <h1 style="color: white">智慧党建</h1>
                    </div>
                    <div class="logo-element">
                        党建
                    </div>
                </li>
                <li class="active">
                    <a href="index.html"><i class="fa fa-th-large"></i> <span class="nav-label">党建促脱贫</span> <span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level collapse">
                        <li>
                            <a href="#">网上讲习所<span class="fa arrow"></span></a>
                            <ul class="nav nav-third-level">
                                <li>
                                    <a href="home.html">习近平新时代中国特色社会主义思想</a>
                                </li>
                                <li>
                                    <a href="home_teach.html">新时代学习大讲堂</a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <!-- <a href="#">驻村干部管理<span class="fa arrow"></span></a>
                            <ul class="nav nav-third-level">
                                <li>
                                    <a href="ganbu_manage.html#">人员管理</a>
                                </li>
                                <li>
                                    <a href="daily_manage.html#">日常管理</a>
                                </li>
                                <li>
                                    <a href="daily_service.html#">日常服务</a>
                                </li>
                            </ul> -->
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="flags_piao.html"><i class="fa fa-diamond"></i> <span class="nav-label">党旗飘飘</span></a>
                </li>
                <li>
                    <a href="flags_people.html"><i class="fa fa-diamond"></i> <span class="nav-label">党支部管理</span></a>
                </li>
                <li>
                    <a href="news_manage.html"><i class="fa fa-diamond"></i> <span class="nav-label">党建新闻管理</span></a>
                </li>
                <li>
                    <a href="three_sessions.html"><i class="fa fa-diamond"></i> <span class="nav-label">三会一课</span></a>
                </li>
                <li>
                    <a href="table_data_tables.html#"><i class="fa fa-bar-chart-o"></i> <span class="nav-label">云学习中心</span><span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level collapse">
                             <!-- <li><a href="graph_flot.html">教学资源</a></li> -->
                        <li><a href="examination_paper_list.html">考试管理</a></li>
                        <li><a href="test_manage.html">考试题管理</a></li>
                        <li><a href="study_credit_list.html">在线学习学分配置</a></li>
                        <!-- <li><a href="graph_chartjs.html">活动开展情况</a></li> -->
                    </ul>
                </li>
                <!--<li>-->
                <!--<a href="#"><i class="fa fa-wrench"></i> <span class="nav-label">系统管理</span><span class="fa arrow"></span></a>-->
                <!--<ul class="nav nav-second-level collapse" >-->
                <!--<li><a href="#">系统配置</a></li>-->
                <!--<li><a href="#">权限管理</a></li>-->
                <!--<li><a href="login.html">退出</a></li>-->
                <!--</ul>-->
                <!--</li>-->

            </ul>

        </div>
    </nav>

    <div id="page-wrapper" class="gray-bg">
        <div class="row border-bottom">
            <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0">
                <div class="navbar-header">
                    <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="mytext_add.html#"><i class="fa fa-bars"></i> </a>
                    <form role="search" class="navbar-form-custom" action="#">
                        <div class="form-group">
                            <input type="text" placeholder="Search for something..." class="form-control" name="top-search" id="top-search">
                        </div>
                    </form>
                </div>
                <!--<ul class="nav navbar-top-links navbar-right">-->
                <!--<li>-->
                <!--<span class="m-r-sm text-muted welcome-message">欢迎来到智慧党建系统</span>-->
                <!--</li>-->
                <!--<li class="dropdown">-->
                <!--<a class="dropdown-toggle count-info" data-toggle="dropdown" href="table_data_tables.html#">-->
                <!--<i class="fa fa-envelope"></i>  <span class="label label-warning">0</span>-->
                <!--</a>-->

                <!--&lt;!&ndash;邮件信息&ndash;&gt;-->
                <!--&lt;!&ndash;<ul class="dropdown-menu dropdown-messages">&ndash;&gt;-->
                <!--&lt;!&ndash;<li>&ndash;&gt;-->
                <!--&lt;!&ndash;<div class="dropdown-messages-box">&ndash;&gt;-->
                <!--&lt;!&ndash;<a href="profile.html" class="pull-left">&ndash;&gt;-->
                <!--&lt;!&ndash;<img alt="image" class="img-circle" src="img/a7.jpg">&ndash;&gt;-->
                <!--&lt;!&ndash;</a>&ndash;&gt;-->
                <!--&lt;!&ndash;<div class="media-body">&ndash;&gt;-->
                <!--&lt;!&ndash;<small class="pull-right">46h ago</small>&ndash;&gt;-->
                <!--&lt;!&ndash;<strong>Mike Loreipsum</strong> started following <strong>Monica Smith</strong>. <br>&ndash;&gt;-->
                <!--&lt;!&ndash;<small class="text-muted">3 days ago at 7:58 pm - 10.06.2014</small>&ndash;&gt;-->
                <!--&lt;!&ndash;</div>&ndash;&gt;-->
                <!--&lt;!&ndash;</div>&ndash;&gt;-->
                <!--&lt;!&ndash;</li>&ndash;&gt;-->
                <!--&lt;!&ndash;<li class="divider"></li>&ndash;&gt;-->
                <!--&lt;!&ndash;</ul>&ndash;&gt;-->
                <!--&lt;!&ndash;&ndash;&gt;-->

                <!--</li>-->
                <!--<li class="dropdown">-->
                <!--<a class="dropdown-toggle count-info" data-toggle="dropdown" href="table_data_tables.html#">-->
                <!--<i class="fa fa-bell"></i>  <span class="label label-primary">0</span>-->
                <!--</a>-->

                <!--&lt;!&ndash;待办提示&ndash;&gt;-->
                <!--&lt;!&ndash;<ul class="dropdown-menu dropdown-alerts">&ndash;&gt;-->
                <!--&lt;!&ndash;<li>&ndash;&gt;-->
                <!--&lt;!&ndash;<a href="mailbox.html">&ndash;&gt;-->
                <!--&lt;!&ndash;<div>&ndash;&gt;-->
                <!--&lt;!&ndash;<i class="fa fa-envelope fa-fw"></i> You have 16 messages&ndash;&gt;-->
                <!--&lt;!&ndash;<span class="pull-right text-muted small">4 minutes ago</span>&ndash;&gt;-->
                <!--&lt;!&ndash;</div>&ndash;&gt;-->
                <!--&lt;!&ndash;</a>&ndash;&gt;-->
                <!--&lt;!&ndash;</li>&ndash;&gt;-->
                <!--&lt;!&ndash;<li class="divider"></li>&ndash;&gt;-->
                <!--&lt;!&ndash;</ul>&ndash;&gt;-->
                <!--</li>-->


                <!--<li>-->
                <!--<div class="dropdown" style="color: #888888">-->
                <!--<a class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" style="padding: 0;min-height: 0;background-color: #f3f3f4;border: none;">-->
                <!--系统管理员-->
                <!--<span class="caret"></span>-->
                <!--</a>-->
                <!--<ul class="dropdown-menu" aria-labelledby="dropdownMenu1" style="background-color:#f3f3f4 ">-->
                <!--<li><a href="#">我的信息</a></li>-->
                <!--<li><a href="login.html">退出</a></li>-->
                <!--</ul>-->
                <!--</div>-->
                <!--</li>-->
                <!--</ul>-->

            </nav>
        </div>
        <div class="wrapper wrapper-content">

            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox float-e-margins">
                            <input type="hidden" name="user_id" value="{{user_id}}">
                            <div class="ibox-content no-padding" style="border: none">
                                <div class="col-md-12" style="padding: 10px 0px">
                                    <div class="col-md-2" style="text-align: right;margin-top: 7px">
                                        <strong>标题：</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control"   name="title" ng-model="title">
                                    </div>
                                </div>
                                <div class="col-md-12" style="padding: 10px 0px">
                                    <div class="col-md-2" style="text-align: right;margin-top: 7px">
                                        <strong>文章摘要：</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control"   name="abstract" ng-model="abstract">
                                    </div>
                                </div>
                                <div class="col-md-12" style="padding: 10px 0px 26px 0px;">
                                    <div class="col-md-2" style="text-align: right;margin-top: 7px">
                                        <strong>文章类型：</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <select class="form-control" name="type_id" ng-model="type_id">
                                            <option value="21">习近平新时代中国特色社会主义思想</option>
                                            <option value="22">新时代学习大讲堂</option>
                                            <option value="23">党建</option>
                                            <option value="24">农技</option>
                                            <option value="25">教育</option>
                                            <option value="26">法律</option>
                                            <option value="27">科技</option>
                                            <option value="28">其他</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-12" style="padding: 10px 0px">
                                    <div class="col-md-2" style="text-align: right;margin-top: 7px">
                                        <strong>学分：</strong>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control"   name="period"  ng-model="period">
                                    </div>
                                    <div class="col-md-1" style="text-align: right;margin-top: 7px">
                                        <strong>老师：</strong>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control"   name="teacher" ng-model="teacher">
                                    </div>
                                </div>
                                <div class="col-md-12 b-r" style="margin: 10px 0px">
                                    <div class="form-group" style="position: relative">
                                        <div class="col-md-2" style="text-align: right;margin-top: 7px">
                                            <label style="display: block">封面图：</label>
                                        </div>
                                        <div class="col-md-2">
                                            <img src="{{coverjiu}}" id="cover_img" style="width: 50px;height: 20px">
                                            <form id="form1" enctype="multipart/form-data" method="post" >
                                                <input type="file"   id="exampleInputFile"  name="file" onchange="angular.element(this).scope().upload()">
                                                <!--<button class="btn btn-white" style="float: left">选择文件</button>-->
                                                <!--<label style="margin: 8px 20px;float: left" class="show"></label>-->
                                            </form>
                                        </div>
                                        <div class="col-md-2" style="text-align: left;">
                                            <strong style="margin-top: 8px;">是否是视频教程：</strong><input checked type="checkbox" style="width: 20px;height: 20px" name="video" ng-model="video" ng-change="shifoushiping()">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12 b-r" ng-show="isShow">
                                    <div class="form-group" style="position: relative">
                                        <div class="col-md-2" style="text-align: right;margin-top: 7px">
                                            <label style="display: block">视频地址：</label>
                                        </div>
                                        <div class="col-md-6">
                                            <input type="url" class="form-control" placeholder="在此输入视频地址" name="urls" ng-model="urls">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="ibox-content no-padding" style="background-color: #f3f3f4;border: none">
                                <script id="editor"  type="text/plain" class="ued" name="content"></script>
                                <div class="mail-body text-right tooltip-demo">
                                    <button  class="btn btn-sm btn-primary" data-toggle="tooltip"  ng-click="subtijiao()" >提交</button>
                                    <a href="home.html" class="btn btn-white btn-sm" data-toggle="tooltip">取消</a>
                                </div>
                            </div>



                    </div>
                </div>
            </div>

        </div>

    </div>

</div>
</div>



<!-- Mainly scripts -->
<script src="../js/jquery-2.1.1.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="../js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

<!-- Custom and plugin javascript -->
<script src="../js/inspinia.js"></script>
<script src="../js/plugins/pace/pace.min.js"></script>

<!--Ueditor-->
<script type="text/javascript"  charset="utf-8" src="js/utf8-php/ueditor.config.js"></script>
<script type="text/javascript"  charset="utf-8" src="js/utf8-php/ueditor.all.min.js"></script>
<script type="text/javascript" charset="utf-8" src="js/utf8-php/lang/zh-cn/zh-cn.js"></script>



<!--<script src="js/mytxt.js"></script>-->
<script>
    var app = angular.module('myApp', []);
    app.controller('myCtrl',
        function($scope, $http) {
            var Request = new UrlSearch(); //实例化
            var fileurl = "";
            $scope.username=Request.xingming;
            localStorage.setItem("login_user_name",$scope.username);
            $scope.login_user_name=localStorage.getItem("login_user_name");
            $scope.user_id=Request.user_id;
            $scope.article_id=Request.article_id;
            $scope.title="";
            $scope.type_id="";
            $scope.abstrac="";
            $scope.isShow=false;

            // 这里是把原来的 getActionUrl 方法备份 到 _bkGetActionUrl
            UE.Editor.prototype._bkGetActionUrl = UE.Editor.prototype.getActionUrl;
            UE.Editor.prototype.getActionUrl = function (action) {
                // body...
                console.info(action);

                //拦截这两个，其他的不拦截,调用备份
                if (action == 'uploadimage' || action == 'uploadfile') {
                    return "https://dangjain.ishoubei.com/upload";
                } else{
                    return this._bkGetActionUrl.call(this, action);
                }
            };
            //实例化编辑器
            //建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
            var ue = UE.getEditor('editor',{
                allHtmlEnabled: false,//提交到后台的数据是否包含整个html字符串
                autoHeightEnabled: false,
                autoFloatEnabled: true,
                allowDivTransToP: false//阻止div标签自动转换为p标签
            });

            $scope.load=function () {
                $http.get("https://dangjain.ishoubei.com/article/"+$scope.article_id)
                    .then(function (res) {
                        $scope.lists=res.data;
                        $scope.type_name=res.data.type_name;
                        $scope.title=res.data.title;
                        $scope.created=res.data.created;
                        $scope.user_id=res.data.user_id;
                        $scope.medias=res.data.medias;
                        $scope.abstract=res.data.abstract;
                        $scope.type_id=res.data.type_id;
                        $scope.status=res.data.status;
                        $scope.credit=res.data.credit;
                        $scope.period=res.data.period;
                        $scope.teacher=res.data.teacher;
                        $scope.coverjiu=res.data.cover;
                        $scope.content=HTMLDecode(res.data.content);
                        console.log(res.data)
                        if(res.data.urls.length > 0){
                            const videoUrl = res.data.urls[0]
                            $scope.isShow = true;
                            $scope.urls = videoUrl;
                            $scope.video = true
                        }
                        function HTMLDecode(text) {
                            var temp = document.createElement("div");
                            temp.innerHTML = text;
                            var output = temp.innerText || temp.textContent;
                            temp = null;
                            return output;
                        }
                        ue.ready(function() {
                            //设置编辑器的内容
                            ue.setContent($scope.content);
                            //获取html内容，返回: <p>hello</p>
                            var html = ue.getContent();
                            //获取纯文本内容，返回: hello
                            var txt = ue.getContentTxt();
                        });
                    });
            }
            ue.addListener("contentChange",function(){

            });
            $scope.shifoushiping=function () {
                if($scope.video==true){
                    $scope.isShow=true;
                }else {
                    $scope.isShow=false;
                }
            }



            $scope.upload=function () {
                console.log('------~~~~~~~-----')
                var form = document.getElementById('form1'),
                    formData = new FormData(form);
                $.ajax({
                    url:"https://dangjain.ishoubei.com/upload",
                    type:"post",
                    data:formData,
                    processData:false,
                    contentType:false,
                    success:function(res){
                        if(res.url){
                            fileurl = res.url
                            console.log($scope.coverjiu)
                            var httpurl="https://dangjain.ishoubei.com"
                            $scope.coverjiu = httpurl+""+fileurl
                            $("#cover_img").attr("src", $scope.coverjiu)
                            console.log($scope.coverjiu)
                            var  title=res.title
                        }else {
                            alert("图片错误，请重新选择图片")
                        }


                    },
                    error:function(err){
                        alert("网络连接失败,稍后重试",err);
                    }
                })
            }

            $scope.subtijiao=function () {

                var httpurl="https://dangjain.ishoubei.com"
                var imageurl=httpurl+""+fileurl
                   if(imageurl="https://dangjain.ishoubei.com"){
                       imageurl=$scope.coverjiu
                   }

                $scope.data1 = {
                    user_id: $scope.user_id,
                    title: $scope.title,
                    type_id:$scope.type_id,
                    abstract:$scope.abstract,
                    content:ue.getContent(),
                    period:$scope.period,
                    credit:$scope.credit,
                    teacher:$scope.teacher,
                    cover:imageurl,
                    urls:$scope.urls
                };

                var url = "https://dangjain.ishoubei.com/article/"+$scope.article_id;
                var transFn = function (data) { return $.param(data) },
                    postCfg = { headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' }, transformRequest: transFn };
                $http.post(url,$scope.data1,postCfg).success(function (res) {
                    if($scope.type_id==21){
                        window.location.href="home.html"
                    }else {
                        window.location.href="home_teach.html"
                    }
                });
            }

            function UrlSearch() {
                var name, value;
                var str = location.href; //取得整个地址栏
                console.log("地址="+str);
                var num = str.indexOf("?");
                str = str.substr(num + 1); //取得所有参数   stringvar.substr(start [, length ]

                var arr = str.split("&"); //各个参数放到数组里
                console.log("各个参数放到数组里="+arr);
                for (var i = 0; i < arr.length; i++) {
                    num = arr[i].indexOf("=");
                    if (num > 0) {
                        name = arr[i].substring(0, num);
                        value = arr[i].substr(num + 1);
                        this[name] = value;
                    }
                }
            }
        });

</script>



</body>

</html>
